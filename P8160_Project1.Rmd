---
title: "P8160_Project1_Survival"
author: "Yi Huang, yh3554"
date: "2023-02-19"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", warning = FALSE)
library(simsurv)
library(survival)
library(tidyverse)
library(ggplot2)
library(patchwork)
```

# Project 1: Design a simulation study to compare three survival models


## Examples : Simsurv Package Data Generarion 

```{r}
set.seed(2023)
# tot number of patients
N <- 1000

# define covariates
covs <- data.frame(id = 1:N, trt = stats::rbinom(N, 1, 0.5))

## Exponential
exp_dist <- simsurv(dist = "exponential", lambdas = 0.5, 
                    x = covs, betas = c(trt = -0.5), maxt = 5)


## Weibull
weibull_dist <- simsurv(dist <- "weibull", lambdas = 0.5, gammas = 0.05, 
                        x = covs, betas = c(trt = -0.5), maxt = 5)


## Gompertz
gompertz_dist <- simsurv(dist = "gompertz", lambdas = 0.1, gammas = 0.05, 
                         x = covs, betas = c(trt = -0.5), maxt = 5)

```

## Generate Gompertz distribution use inverse transformation method
```{r}
gen_gompertz <- function(alpha = 0.5, lambda = 0.5, b1 = -0.5, n, seed) {
  # Generate a random sample from the uniform distribution
  set.seed(seed)
  u <- runif(n)
  x <- rep(0, n)
  x <- (1/alpha)*log(1-(alpha*log(u)/(lambda*exp(x*b1)))) 

  return(x)
  
}

sample_gompertz <- gen_gompertz(n=1000, seed = 123123)
df <- data.frame(sample_gompertz)

# Visualization to validate the algorithm
 df %>% ggplot(aes(x = sample_gompertz)) +
  geom_histogram(aes(y = after_stat(density)),
                 colour = 1, fill = "red", bins = 30) +
  geom_density() + xlab("x") + ggtitle("Density Distribution")
```

## Generate Gompertz distribution using simsurv package
```{r}
generate_gompertz = function(gamma, N, seed){
  set.seed(seed)
  #gen gompertz data
  covs <- data.frame(id = 1:N,
                    trt = stats::rbinom(N, 1, 0.5))
  dat <- simsurv(dist = "gompertz",
                 lambdas = 0.5, 
                 gammas = gamma, 
                 betas = c(trt = -0.5), 
                 x = covs, 
                 maxt = 5)
  dat <- merge(covs, dat)
  return(dat)
}
gompertz_dat <- generate_gompertz(1, 1000, 2023)

eventtime <- data.frame(gompertz_dat$eventtime)

# Visualization to validate the algorithm
eventtime %>% ggplot(aes(x = gompertz_dat.eventtime)) +
  geom_histogram(aes(y = after_stat(density)),
                 colour = 1, fill = "red", bins = 30) +
  geom_density() + xlab("x") + ggtitle("Density Distribution")
```



## fit model
```{r}
# fit Exponential
fit.exponential <- survreg(Surv(eventtime, status) ~ trt, data = gompertz_dat, dist = "exponential") 
summary(fit.exponential)
-fit.exponential$coefficients[-1]

# fit Weibull
fit.weibull <- survreg(Surv(eventtime, status) ~ trt, data = gompertz_dat, dist = "weibull") 
summary(fit.weibull)
-fit.weibull$coefficients[-1] / fit.weibull$scale

#fit Cox model
fit.cox <- coxph(Surv(eventtime, status) ~ trt, data = gompertz_dat) 
summary(fit.cox)
```

# Plot of Baseline Hazard Function
```{r}

```




# Simulation for Gompertz

- N: sample size 100, 150, 200, 250, 300, 350, 400
- m: simulation time 1000
- $\beta$: true treatment effect to be -0.5
- $\lambda$: 0.5
- $\gamma$: 0.05, 1, 1.5

```{r}
#write a fn to simulate gompertz data
sim_gompertz <- function(k, gamma=0.05, N){
  #generate gompertz data
  covs <- data.frame(id = 1:N,
                    trt = stats::rbinom(N, 1, 0.5))
  dat <- simsurv(dist = "gompertz",
                 lambdas = 0.5, 
                 gammas = gamma, 
                 betas = c(trt = -0.5), 
                 x = covs, 
                 maxt = 5)
  dat <- merge(covs, dat)
  #fit models
  fit.exponential <- survreg(Surv(eventtime, status) ~ trt, data = dat, dist = "exponential")
  fit.weibull <- survreg(Surv(eventtime, status) ~ trt, data = dat, dist = "weibull")
  fit.cox <- coxph(Surv(eventtime, status) ~ trt, data = dat)
  
  #extract beta
  result <- tibble(exp_beta = c(-fit.exponential$coefficients[-1]), 
                  weibull_beta = c(-fit.weibull$coefficients[-1])/fit.weibull$scale,
                  cox_beta = c(fit.cox$coefficients), 
                  dist = "gompertz",
                  beta = -0.5, 
                  gamma = gamma,
                  N = N)
  return(result)
  }

# Set seed for reproducibility
set.seed(2023)

# Create empty dataframe to store results
sim_gompertz_result1 <- data.frame()

# Simulate 1000 times
#gamma=0.05
for (n in c(100, 150, 200, 250, 300, 350, 400)) {
for (i in 1:1000) {
  sim_res <- sim_gompertz(gamma = 0.05, N = n)
  sim_gompertz_result1 <- rbind(sim_gompertz_result1, sim_res)
}
}

gompertz_table1 <- sim_gompertz_result1 %>% 
  group_by(N) %>%
  summarize(mse_exp_ = mean((exp_beta+0.5)^2),
            mse_weibull = mean((weibull_beta+0.5)^2),
            mse_cox = mean((cox_beta+0.5)^2),
            var_exp = var(exp_beta),
            var_weibull = var(weibull_beta),
            var_cox = var(cox_beta),
            bias_exp = mean(exp_beta+0.5),
            bias_weibull = mean(weibull_beta+0.5),
            bias_cox = mean(cox_beta+0.5)
        
  )
gompertz_table1





#gamma=1
set.seed(2023)
sim_gompertz_result2 <- data.frame()
for (n in c(100, 150, 200, 250, 300, 350, 400)) {
for (i in 1:1000) {
  sim_res <- sim_gompertz(gamma = 1, N = n)
  sim_gompertz_result2 <- rbind(sim_gompertz_result2, sim_res)
}
}

gompertz_table2 <- sim_gompertz_result2 %>% 
  group_by(N) %>%
  summarize(mse_exp_ = mean((exp_beta+0.5)^2),
            mse_weibull = mean((weibull_beta+0.5)^2),
            mse_cox = mean((cox_beta+0.5)^2),
            var_exp = var(exp_beta),
            var_weibull = var(weibull_beta),
            var_cox = var(cox_beta),
            bias_exp = mean(exp_beta+0.5),
            bias_weibull = mean(weibull_beta+0.5),
            bias_cox = mean(cox_beta+0.5)
        
  )
gompertz_table2



#gamma=1.5
set.seed(2023)
sim_gompertz_result3 <- data.frame()
for (n in c(100, 150, 200, 250, 300, 350, 400)) {
for (i in 1:1000) {
  sim_res <- sim_gompertz(gamma = 1, N = n)
  sim_gompertz_result3  <- rbind(sim_gompertz_result3 , sim_res)
}
}

gompertz_table3 <- sim_gompertz_result3  %>% 
  group_by(N) %>%
  summarize(mse_exp_ = mean((exp_beta+0.5)^2),
            mse_weibull = mean((weibull_beta+0.5)^2),
            mse_cox = mean((cox_beta+0.5)^2),
            var_exp = var(exp_beta),
            var_weibull = var(weibull_beta),
            var_cox = var(cox_beta),
            bias_exp = mean(exp_beta+0.5),
            bias_weibull = mean(weibull_beta+0.5),
            bias_cox = mean(cox_beta+0.5)
        
  )
gompertz_table3
```


# Simulation for Exponential

- N: sample size 100, 150, 200, 250, 300, 350, 400
- m: simulation time 1000
- $\beta$: true treatment effect to be -0.5
- $\lambda$: 0.5

```{r}
#write a fn to simulate exponential data
sim_exp <- function(k, N){
  #generate exponential data
  covs <- data.frame(id = 1:N,
                    trt = stats::rbinom(N, 1, 0.5))
  dat <- simsurv(dist = "exponential",
                 lambdas = 0.5, 
                 betas = c(trt = -0.5), 
                 x = covs, 
                 maxt = 5)
  dat <- merge(covs, dat)
  #fit models
  fit.exponential <- survreg(Surv(eventtime, status) ~ trt, data = dat, dist = "exponential")
  fit.weibull <- survreg(Surv(eventtime, status) ~ trt, data = dat, dist = "weibull")
  fit.cox <- coxph(Surv(eventtime, status) ~ trt, data = dat)
  
  #extract beta
  result <- tibble(exp_beta = c(-fit.exponential$coefficients[-1]), 
                  weibull_beta = c(-fit.weibull$coefficients[-1])/fit.weibull$scale,
                  cox_beta = c(fit.cox$coefficients), 
                  dist = "exponential",
                  beta = -0.5, 
                  gamma = "default",
                  N = N)
  return(result)
  }

# Set seed for reproducibility
set.seed(2023)

# Create empty dataframe to store results
sim_exp_result1  <- data.frame()

# Simulate 1000 times
for (n in c(100, 150, 200, 250, 300, 350, 400)) {
for (i in 1:1000) {
  sim_res <- sim_exp(N = n)
  sim_exp_result1 <- rbind(sim_exp_result1, sim_res)
}
}

exponential_table <- sim_exp_result1 %>% 
  group_by(N) %>%
  summarize(mse_exp_ = mean((exp_beta+0.5)^2),
            mse_weibull = mean((weibull_beta+0.5)^2),
            mse_cox = mean((cox_beta+0.5)^2),
            var_exp = var(exp_beta),
            var_weibull = var(weibull_beta),
            var_cox = var(cox_beta),
            bias_exp = mean(exp_beta+0.5),
            bias_weibull = mean(weibull_beta+0.5),
            bias_cox = mean(cox_beta+0.5)
        
  )

exponential_table
```


# Simulation for Weibull

- N: sample size 100, 150, 200, 250, 300, 350, 400
- m: simulation time 1000
- $\beta$: true treatment effect to be -0.5
- $\lambda$: 0.5
- $\gamma$: 0.05, 1, 1.5

```{r}
#write a fn to simulate weibull data
sim_weibull <- function(k, gamma=0.05, N){
  #generate weibull data
  covs <- data.frame(id = 1:N,
                    trt = stats::rbinom(N, 1, 0.5))
  dat <- simsurv(dist = "weibull",
                 lambdas = 0.5, 
                 gammas = gamma, 
                 betas = c(trt = -0.5), 
                 x = covs, 
                 maxt = 5)
  dat <- merge(covs, dat)
  #fit models
  fit.exponential <- survreg(Surv(eventtime, status) ~ trt, data = dat, dist = "exponential")
  fit.weibull <- survreg(Surv(eventtime, status) ~ trt, data = dat, dist = "weibull")
  fit.cox <- coxph(Surv(eventtime, status) ~ trt, data = dat)
  
  #extract beta
  result <- tibble(exp_beta = c(-fit.exponential$coefficients[-1]), 
                  weibull_beta = c(-fit.weibull$coefficients[-1])/fit.weibull$scale,
                  cox_beta = c(fit.cox$coefficients), 
                  dist = "weibull",
                  beta = -0.5, 
                  gamma = gamma,
                  N = N)
  return(result)
  }

# Set seed for reproducibility
set.seed(2023)

# Create empty dataframe to store results
sim_weibull_result1 <- data.frame()

# Simulate 1000 times
#gamma=0.05
for (n in c(100, 150, 200, 250, 300, 350, 400)) {
for (i in 1:1000) {
  sim_res <- sim_weibull(gamma = 0.05, N = n)
  sim_weibull_result1 <- rbind(sim_weibull_result1, sim_res)
}
}

weibull_table1 <- sim_weibull_result1 %>% 
  group_by(N) %>%
  summarize(mse_exp_ = mean((exp_beta+0.5)^2),
            mse_weibull = mean((weibull_beta+0.5)^2),
            mse_cox = mean((cox_beta+0.5)^2),
            var_exp = var(exp_beta),
            var_weibull = var(weibull_beta),
            var_cox = var(cox_beta),
            bias_exp = mean(exp_beta+0.5),
            bias_weibull = mean(weibull_beta+0.5),
            bias_cox = mean(cox_beta+0.5)
        
  )
weibull_table1


#gamma=1
sim_weibull_result2 <- data.frame()
for (n in c(100, 150, 200, 250, 300, 350, 400)) {
for (i in 1:1000) {
  sim_res <- sim_weibull(gamma = 1, N = n)
  sim_weibull_result2 <- rbind(sim_weibull_result2, sim_res)
}
}

weibull_table2 <- sim_weibull_result1 %>% 
  group_by(N) %>%
  summarize(mse_exp_ = mean((exp_beta+0.5)^2),
            mse_weibull = mean((weibull_beta+0.5)^2),
            mse_cox = mean((cox_beta+0.5)^2),
            var_exp = var(exp_beta),
            var_weibull = var(weibull_beta),
            var_cox = var(cox_beta),
            bias_exp = mean(exp_beta+0.5),
            bias_weibull = mean(weibull_beta+0.5),
            bias_cox = mean(cox_beta+0.5)
        
  )
weibull_table2

#gamma=1.5
sim_weibull_result3 <- data.frame()
for (n in c(100, 150, 200, 250, 300, 350, 400)) {
for (i in 1:1000) {
  sim_res <- sim_weibull(gamma = 1.5, N = n)
  sim_weibull_result3 <- rbind(sim_weibull_result3, sim_res)
}
}

weibull_table3 <- sim_weibull_result1 %>% 
  group_by(N) %>%
  summarize(mse_exp_ = mean((exp_beta+0.5)^2),
            mse_weibull = mean((weibull_beta+0.5)^2),
            mse_cox = mean((cox_beta+0.5)^2),
            var_exp = var(exp_beta),
            var_weibull = var(weibull_beta),
            var_cox = var(cox_beta),
            bias_exp = mean(exp_beta+0.5),
            bias_weibull = mean(weibull_beta+0.5),
            bias_cox = mean(cox_beta+0.5)
        
  )
weibull_table3
```





# Comparing the accuracy and efficiency of treatment effect (\beta)

*k*: the number of independent data sets\


#### Bias

*Exponential Proportional-Hazards Model*: \
$$Bias=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{exp}^{(k)}}-\beta_{1})=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{exp}^{(k)}}-0.5)$$\

*Weibull Proportional-Hazards Model*: \
$$Bias=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{weibull}^{(k)}}-\beta_{1})=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{weibull}^{(k)}}-0.5)$$\

*Cox Proportional-Hazards Model*: \
$$Bias=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{cox}^{(k)}}-\beta_{1})=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{cox}^{(k)}}-0.5)$$\


#### Variance

*Exponential Proportional-Hazards Model*: \
$$Variance= \frac{1}{k-1}\sum_{i=1}^k\hat{(\beta_{exp}^{(k)}}-\beta_{1})^2=\frac{1}{k-1}\sum_{i=1}^k\hat{(\beta_{exp}^{(k)}}-0.5)^2$$\

*Weibull Proportional-Hazards Model*: \
$$Variance= \frac{1}{k-1}\sum_{i=1}^k\hat{(\beta_{weibull}^{(k)}}-\beta_{1})^2=\frac{1}{k-1}\sum_{i=1}^k\hat{(\beta_{weibull}^{(k)}}-0.5)^2$$\

*Cox Proportional-Hazards Model*: \
$$Variance= \frac{1}{k-1}\sum_{i=1}^k\hat{(\beta_{cox}^{(k)}}-\beta_{1})^2=\frac{1}{k-1}\sum_{i=1}^k\hat{(\beta_{cox}^{(k)}}-0.5)^2$$\


#### MSE

*Exponential Proportional-Hazards Model*: \
$$MSE= \frac{1}{k}\sum_{i=1}^k(\hat{\beta_{exp}^{(k)}}-\beta_{1})^2=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{exp}^{(k)}}-0.5)^2$$\

*Weibull Proportional-Hazards Model*: \
$$MSE= \frac{1}{k}\sum_{i=1}^k(\hat{\beta_{weibull}^{(k)}}-\beta_{1})^2=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{weibull}^{(k)}}-0.5)^2$$\

*Cox Proportional-Hazards Model*: \
$$MSE= \frac{1}{k}\sum_{i=1}^k(\hat{\beta_{cox}^{(k)}}-\beta_{1})^2=\frac{1}{k}\sum_{i=1}^k(\hat{\beta_{cox}^{(k)}}-0.5)^2$$\
